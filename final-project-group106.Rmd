---
title: "Data Analysis and Prediction for Life Expectancy"
author: "Group 106: Artsiom Strok, Lin Jiang, Mayank Chhablani"
date: 'July 15, 2019'
output:
  html_document:
    toc: yes
  pdf_document: default
urlcolor: cyan
---

***

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
options(scipen = 1, digits = 4, width = 80)
```

## Introduction


Life expectancy has increased dramatically over the last few centuries. Since 1900 the global average life expectancy has more than doubled and there has been a huge development in health sector in the past 15 years resulting in improvement of human mortality rates especially in the developing nations in comparison to the past 30 years. Therefore, in this project, only data from year 2000-2015 is considered for exploration and analysis. 

This dataset is a compilation of data from the Global Health Observatory (GHO) and United Nations. The GHO data repository is WHO's gateway to health-related statistics which provides access to a variety of indicators on priority health topics including mortality and burden of diseases, environmental health, violence and injuries etc. (http://apps.who.int/gho/data/node.resources). The economic data such as GDP is collected from the National Accounts Main Aggregates Database under United Nations which collects and disseminates economic statistics from countries worldwide (https://unstats.un.org/unsd/snaama/Index).

This dataset is cleaned by removing some missing values, maily for population, Hepatitis B and GDP from less known countries and shared on Kaggle website (https://www.kaggle.com/kumarajarshi/life-expectancy-who). The final dataset contains 2938 observations with 22 variables which are more critical and representative among all the categories of health-related factors from year 2000 - 2015 for 193 countries.

The description of each variable for this dataset is listed below:

- **Country**: Country
- **Year**: Year
- **Status**: Developed or Developing status
- **Life expectancy**: Life Expectancy in age
- **Adult Mortality**: Adult Mortality Rates of both sexes (probability of dying between 15 and 60 years per 1000 population)
- **infant**: deathsNumber of Infant Deaths per 1000 population
- **Alcohol**: Alcohol, recorded per capita (15+) consumption (in litres of pure alcohol)
- **percentage expenditure**: Expenditure on health as a percentage of Gross Domestic Product per capita(%)
- **Hepatitis B**: Hepatitis B (HepB) immunization coverage among 1-year-olds (%)
- **Measles**: Measles - number of reported cases per 1000 population
- **BMI**: Average Body Mass Index of entire population
- **under-five deaths**: Number of under-five deaths per 1000 population
- **Polio**: Polio (Pol3) immunization coverage among 1-year-olds (%)
- **Total expenditure**: General government expenditure on health as a percentage of total government expenditure (%)
- **Diphtheria**: Diphtheria tetanus toxoid and pertussis (DTP3) immunization coverage among 1-year-olds (%)
- **HIV/AIDS**: Deaths per 1 000 live births HIV/AIDS (0-4 years)
- **GDP**: Gross Domestic Product per capita (in USD)
- **Population**: Population of the country
- **thinness 1-19 years**: Prevalence of thinness among children and adolescents for Age 10 to 19 (% )
- **thinness 5-9 years**: Prevalence of thinness among children for Age 5 to 9(%)
- **Income composition of resources**: Human Development Index in terms of income composition of resources (index ranging from 0 to 1)
- **Schooling**: Number of years of Schooling(years)

For this project, we would like to:

- identify the major factors that affect the life expectancy
- explore the interactions between the variables such as immunization, moratlity, education, economic factors etc.
- discover the corelation between different factors
- perform residual and outlier diagnostics to exclude some influential points if any
- build a robust multiple linear regression model to predict the life expectancy
- build a classifier to estimate the status of a country (developing or developed)


***

## Methods

```{r, message=FALSE, warning=FALSE, include=FALSE}
#install.packages("DAAG")
#install.packages("corrplot")
#install.packages("ggplot2")
#install.packages("tidyr")
#install.packages("GGally")
library(DAAG)
library(corrplot)
library(ggplot2)
library(magrittr)
library(knitr)
library(tidyr)
library(GGally)
library(faraway)
library(lmtest)
set.seed(42)
```


### Missing values analysis:

```{r}
original_data = read.csv("Life Expectancy Data.csv")
kable(t(original_data[sample(nrow(original_data), 5), ]))
kable(colSums(is.na(original_data)), col.names = "Number of missing values")
```


1289 samples have at least one missing value. Alcohol is missing in 194 samples all of them belongs to 2015 year and these countiries definately should have alcohol consuption more than 0. The data was collected in 2015 when data about alcohol consumption simply was not available.

Life expextancy and adult mortality is missing for 10 samples in 2013, all of them belongs to islands.

Hepatitis B is missing in 553 samples. Samples belongs to different countries and years.

```{r}
nrow(original_data)
data = na.omit(original_data)
nrow(original_data) - nrow(data)
summary(data)
```

Looking at the summary data we can already see some inconsistencies. In `Infant Deaths` we see that the max value listed is 1600 which doesn't make sense since we're working with per 1000 population data. The same or similar numbers we can see for `Infant deaths`, `Measles`, `Under five deaths`
```{r}

boxplot(data$Adult.Mortality)
kable(t(head(data[data$Adult.Mortality > boxplot(data$Adult.Mortality)$stats[5], ])))

boxplot(data$infant.deaths)
boxplot(data$infant.deaths)$stats[5]
kable(t(head(data[data$infant.deaths > 200, ])))

boxplot(data$Measles)
kable(t(head(data[data$Measles > boxplot(data$Measles)$stats[5], ])))

boxplot(data$under.five.deaths)
kable(t(head(data[data$under.five.deaths > boxplot(data$under.five.deaths)$stats[5], ])))
```



```{r}
ggplot(gather(data[-c(1, 3)]), aes(value)) + 
    geom_histogram(bins = 10) + 
    facet_wrap(~key, scales = 'free_x')
ggplot(data, aes(x = Status, y = Life.expectancy)) + geom_boxplot()
ggplot(data, aes(x = Adult.Mortality, y = Life.expectancy)) + geom_boxplot()
```




This original dataset contains `Country` variable which we would not use for model building. Therefore, this column is excluded from the following data analysis as well as the records with `NA` in some of the columns mentioned above. This will reduce the size of the original dataset from 2938 to 1649 rows, which captures majority of the information and allows the speed of modeling to be more efficient.

Below lists the summary and structure of the cleaned dataset.

```{r}
summary(data)
data = na.omit(data)
data = data[-1] #exclude country from dataset
str(data)
```


### Data Visualization

Let's take a look of the dataset using plots of `Life Expectancy` vs `Status` or `Year`. The boxplot indicates that there is significant difference in `Life Expectancy` between the `Developed` and `Developing` countries. As expected, the `Life Expectancy` increases as the `Year` passes by and the Violin plot shows that the data is well distributed across different years.

```{r}
par(mfrow=c(1,2))
# Histogram of Life Expectancy
hist(data$Life.expectancy,
     xlab = "Life Expectancy",
     main = "Distribution of Life Expectancy",
     col = "dodgerblue",
     breaks = 25)
# Boxplot of Life Expectancy vs Country Status (Developed vs Developing)
plot(data$Status,
     data$Life.expectancy,
     xlab = "Status",
     ylab = "Life Expectancy",
     main = "Life Expectancy vs. Status",
     col = c(2,3))

# Violin plot of Life Expectancy vs. Year
data %>% ggplot() + geom_violin(aes(x=Year, y=Life.expectancy, group=Year, fill=Year)) + labs(title = "Life Expectancy vs. Year")
```


### Colinearity

Colinearity issue is visualized using the following plots. Resulsts show that some predictors have strong collinearity issues, such as `infant.deaths` vs. `under.five.deaths`, `GDP` vs. `percentage.expenditure`, `Population` vs. `thinness..1.19.years` etc.

```{r message=FALSE, warning=FALSE}
corrplot(cor(data[-c(2)]), method = "circle")
ggpairs(data[-c(2)])
round(cor(data[-c(2)]),2)
```



```{r}

# train test split 70/30 hold out
train_size = floor(0.7 * nrow(data))
train_idx = sample(nrow(data), train_size)
data.train = data[train_idx, ]
data.test = data[-train_idx, ]


model.additive = lm(Life.expectancy ~ ., data.train)
cv.lm(data.train, model.additive, m = 5, plotit = FALSE)
mean((data.test$Life.expectancy - predict(model.additive, data.test)) ^ 2)

model.selected = step(lm(Life.expectancy ~ ., data.train), trace = FALSE)
cv.lm(data.train, model.selected, m = 5, plotit = FALSE)
mean((data.test$Life.expectancy - predict(model.selected, data.test)) ^ 2)

```


VIF for the additive model
```{r}
vif(model.additive)
which(vif(model.additive) > 5)
```

```{r}
vif(model.selected)
which(vif(model.selected) > 5)
```

The selected model efficiently removed some predictors which have colinearity issues, but not all. We can see infant.deaths and under.five.deaths are still co-exist in the selected model.


```{r}
plot(infant.deaths ~ under.five.deaths, data = data)
```

### Model Building
```{r}
# train test split 70/30 hold out
set.seed(42)
train_size = floor(0.7 * nrow(data))
train_idx = sample(nrow(data), train_size)
data_trn = data[train_idx, ]
data_tst = data[-train_idx, ]
```

```{r}
# Define functions
calc_loocv_rmse = function(model) {
  c("LOOCV_RMSE:",sqrt(mean((resid(model) / (1 - hatvalues(model))) ^ 2)))
}

calc_bp = function(model) {
  c("BP test:", unname(bptest(model)$p.value))
}

calc_shapiro = function(model) {
  c("Shapiro test:", unname(shapiro.test(resid(model))$p.value))
}

calc_adj_r2 = function(model) {
  c("Adj.R2:", summary(model)$adj.r.squared)
}
```

```{r}
# Model_1, basic additive model with all the parameters
model_1 = lm(Life.expectancy ~ ., data_trn)
par(mfrow=c(2,2))
plot(model_1)
calc_bp(model_1)
calc_shapiro(model_1)
calc_loocv_rmse(model_1)
calc_adj_r2(model_1)
```

```{r}
# Model_2, backward AIC on additive model
model_2 = step(model_1, trace = FALSE)
coef(model_2)
par(mfrow=c(2,2))
plot(model_2)
calc_bp(model_2)
calc_shapiro(model_2)
calc_loocv_rmse(model_2)
calc_adj_r2(model_2)

```

```{r}
# Model_3, backward BIC on additive model
n = length(resid(model_1))
model_3 = step(model_1, k = log(n), trace = FALSE)
coef(model_3)
par(mfrow=c(2,2))
plot(model_3)
calc_bp(model_3)
calc_shapiro(model_3)
calc_loocv_rmse(model_3)
calc_adj_r2(model_3)

```

We can see that no big improvement on AIC and BIC results based on the additive model.

Next, we will start with the interactive model.
```{r}
# Model_4, basic interactive model with all the parameters
model_4 = lm(Life.expectancy ~ . ^ 2, data_trn)
par(mfrow=c(2,2))
plot(model_4)
calc_bp(model_4)
calc_shapiro(model_4)
calc_loocv_rmse(model_4)
calc_adj_r2(model_4)
length(coef(model_4))
```

We can see that the interactive model using all the predictors turns out really big and there are 211 parameters in the model. We will focus on the parameters that are selected by Model_2 and apply AIC on the interactive model based on those parameters.


```{r}
# Model_5, interactive model based on Model_2
# under.five.deaths is excluded because the colinearity issue with infant.deanths parameters
coef(model_2)
model_5 = lm(Life.expectancy ~ (Year + Status + Adult.Mortality + infant.deaths + Alcohol + percentage.expenditure + BMI + Polio + Total.expenditure
                                + Diphtheria + HIV.AIDS + thinness..1.19.years + Income.composition.of.resources + Schooling) ^ 2, data = data_trn)
par(mfrow=c(2,2))
plot(model_5)
calc_bp(model_5)
calc_shapiro(model_5)
calc_loocv_rmse(model_5)
calc_adj_r2(model_5)
length(coef(model_5))

```

Model_5 has lower BP and Shapiro test results compared to the first 3 models, however, there are still 106 parameters in the model. We will use AIC and BIC to reduce the model.

```{r}
# Model_6, backward AIC on interactive model
model_6 = step(model_5, trace = FALSE)
par(mfrow=c(2,2))
plot(model_5)
calc_bp(model_5)
calc_shapiro(model_5)
calc_loocv_rmse(model_5)
calc_adj_r2(model_5)
```

```{r}
# Model_7, backward BIC on interactive model
n = length(resid(model_5))
model_7 = step(model_5, k = log(n), trace = FALSE)
par(mfrow=c(2,2))
plot(model_7)
calc_bp(model_7)
calc_shapiro(model_7)
calc_loocv_rmse(model_7)
calc_adj_r2(model_7)
```




We can see that model_7 still have 39 parameters. To simply the model, we can use p-value < 0.0001 to filter predictors. We will also add second order predictors and use AIC/BIC to further reduce model.
```{r}
length(coef(model_7))
which(summary(model_7)$coefficients[,4] < 0.0001)

```

```{r}
model_8 = lm(Life.expectancy ~ Adult.Mortality + BMI + Diphtheria + thinness..1.19.years + Income.composition.of.resources + Schooling +  Year:Income.composition.of.resources + Year:Schooling + Status:Adult.Mortality + Status:thinness..1.19.years + Adult.Mortality:Schooling + infant.deaths:Income.composition.of.resources + infant.deaths:Schooling + Alcohol:Total.expenditure + Alcohol:HIV.AIDS + Alcohol:Income.composition.of.resources + BMI:Diphtheria + BMI:Income.composition.of.resources + BMI:Schooling + Total.expenditure:Income.composition.of.resources + I(Adult.Mortality^2) + I(BMI^2) + I(Diphtheria^2) + I(thinness..1.19.years^2) + I(Income.composition.of.resources^2) + I(Schooling^2), data = data_trn)
length(coef(model_8))
```

```{r}
# Model_9, backward AIC on reduced model
model_9 = step(model_8, trace = FALSE)
par(mfrow=c(2,2))
plot(model_9)
calc_bp(model_9)
calc_shapiro(model_9)
calc_loocv_rmse(model_9)
calc_adj_r2(model_9)
```

```{r}
# Model_10, backward BIC on reduced model
n = length(resid(model_8))
model_10 = step(model_8, k = log(n), trace = FALSE)
par(mfrow=c(2,2))
plot(model_10)
calc_bp(model_10)
calc_shapiro(model_10)
calc_loocv_rmse(model_10)
calc_adj_r2(model_10)
length(coef(model_10))
```
There are still 24 parameters after BIC step.

Change strategy, use the first order predictors in model_8 to build the interactive and second order models and apply AIC/BIC on it.
```{r}
model_11 = lm(Life.expectancy ~ (Adult.Mortality + BMI + Diphtheria + thinness..1.19.years + Income.composition.of.resources + Schooling) ^ 2 + I(Adult.Mortality^2) + I(BMI^2) + I(Diphtheria^2) + I(thinness..1.19.years^2) + I(Income.composition.of.resources^2) + I(Schooling^2), data = data_trn)
length(coef(model_11))
```
```{r}
# Model_12, backward AIC on reduced model_11
model_12 = step(model_11, trace = FALSE)
par(mfrow=c(2,2))
plot(model_12)
calc_bp(model_12)
calc_shapiro(model_12)
calc_loocv_rmse(model_12)
calc_adj_r2(model_12)
length(coef(model_12))
```

```{r}
# Model_13, backward BIC on reduced model_11
n = length(resid(model_11))
model_13 = step(model_11, k = log(n), trace = FALSE)
par(mfrow=c(2,2))
plot(model_13)
calc_bp(model_13)
calc_shapiro(model_13)
calc_loocv_rmse(model_13)
calc_adj_r2(model_13)
length(coef(model_13))
```
## Results

## Discussion

## Appendix
